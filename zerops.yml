zerops:
  - setup: lucky
    build:
      base: ubuntu@22.04
      deployFiles:
        - /
      prepareCommands:
      - sudo apt update
      - sudo apt-get update
      - curl -fsSL https://crystal-lang.org/install.sh | sudo bash
      - sudo apt install crystal
      - sudo apt install git -y
      - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
      - echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
      - sudo apt update && sudo apt install yarn -y
      - sudo apt-get install -y libc6-dev libevent-dev libpcre2-dev libpcre3-dev libpng-dev libssl-dev libyaml-dev zlib1g-dev
      buildCommands:
      - shards install --without-development
      - shards build --production
    run:
      base: ubuntu@22.04
      prepareCommands:
      - wget https://github.com/luckyframework/lucky_cli/releases/download/v1.2.0/lucky-v1.2.0-linux-amd64.tar.gz 
      - tar -xzf lucky-v1.2.0-linux-amd64.tar.gz
      - sudo mv lucky /usr/local/bin/lucky
      ports:
        - port: 3000
          httpSupport: true
      envVariables:
        DB_HOST: luckydb
        DB_PASSWORD: ${db_password}
        DB_PORT: "5432"
        DB_USERNAME: luckydb
      start: lucky dev